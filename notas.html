<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Notas</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Notas">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f2f1ed; color: #000; overflow-x: hidden; -webkit-font-smoothing: antialiased; }
        .list { min-height: 100vh; padding-top: env(safe-area-inset-top); padding-bottom: 80px; }
        .header { background: #f2f1ed; padding: 0 20px; }
        .nav { display: flex; justify-content: space-between; align-items: center; height: 44px; }
        .back { color: #ff9500; font-size: 17px; text-decoration: none; pointer-events: none; }
        .menu-btn { width: 28px; height: 28px; border-radius: 50%; background: none; border: 1.5px solid #ff9500; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .dots { display: flex; gap: 3px; }
        .dot { width: 3px; height: 3px; background: #ff9500; border-radius: 50%; }
        .title { font-size: 34px; font-weight: 700; margin: 4px 0 20px 0; }
        .section { font-size: 22px; font-weight: 700; margin: 20px 20px 10px 20px; }
        .note { background: #fff; border-radius: 10px; padding: 12px 16px; margin: 0 20px 10px 20px; cursor: pointer; }
        .note:active { opacity: 0.7; }
        .note-top { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .note-title { font-size: 16px; font-weight: 600; letter-spacing: -0.32px; }
        .note-date { font-size: 15px; color: rgba(60, 60, 67, 0.6); letter-spacing: -0.24px; }
        .note-preview { font-size: 15px; color: rgba(60, 60, 67, 0.5); letter-spacing: -0.24px; line-height: 20px; }
        .footer { text-align: center; padding: 30px 0; font-size: 13px; color: rgba(60, 60, 67, 0.6); }
        
        /* BOTÓN CREAR - USANDO IMAGEN */
        .create { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            width: 56px; 
            height: 56px; 
            background: transparent; 
            border: none; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .create-icon { 
            width: 28px; 
            height: 28px; 
            background-image: url('icon-create-note.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .detail { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #faf9f7; z-index: 100; padding-top: env(safe-area-inset-top); flex-direction: column; }
        .detail.active { display: flex; }
        .det-header { background: #faf9f7; padding: 0 20px; height: 44px; display: flex; align-items: center; justify-content: space-between; }
        .det-back { color: #ff9500; font-size: 17px; text-decoration: none; }
        .det-tools { display: flex; gap: 18px; }
        .tool { background: none; border: none; padding: 0; cursor: pointer; }
        .share { width: 17px; height: 23px; position: relative; }
        .share-box { width: 17px; height: 12px; border: 1.5px solid #ff9500; border-top: none; border-radius: 0 0 2.5px 2.5px; position: absolute; bottom: 0; }
        .share-line { position: absolute; width: 1.5px; height: 14px; background: #ff9500; top: -1px; left: 50%; transform: translateX(-50%); }
        .share-arrow { position: absolute; width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-bottom: 6px solid #ff9500; top: -6px; left: 50%; transform: translateX(-50%); }
        .more { width: 24px; height: 24px; border-radius: 50%; border: 1.5px solid #ff9500; display: flex; align-items: center; justify-content: center; }
        .more-dots { display: flex; gap: 3px; }
        .more-dot { width: 3px; height: 3px; background: #ff9500; border-radius: 50%; }
        .det-content { flex: 1; overflow-y: auto; padding: 20px 20px; padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        .det-title { font-size: 34px; font-weight: 700; color: #48484a; margin-bottom: 28px; }
        .det-text { font-size: 17px; line-height: 26px; color: #000; white-space: pre-wrap; }
        
        /* Editor */
        .det-edit { width: 100%; min-height: 200px; border: none; background: transparent; font-size: 17px; line-height: 26px; color: #000; font-family: inherit; resize: none; }
        .det-edit:focus { outline: none; }
        
        .menu { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); z-index: 200; align-items: center; justify-content: center; }
        .menu.active { display: flex; }
        .menu-panel { background: rgba(255, 255, 255, 0.94); backdrop-filter: blur(27px); -webkit-backdrop-filter: blur(27px); border-radius: 14px; width: 90%; max-width: 350px; }
        .menu-top { padding: 16px 20px; border-bottom: 0.33px solid rgba(60, 60, 67, 0.29); display: flex; justify-content: space-between; }
        .menu-title { font-size: 17px; font-weight: 600; }
        .close { font-size: 28px; color: rgba(60, 60, 67, 0.6); background: none; border: none; cursor: pointer; }
        .menu-option { padding: 14px 20px; background: transparent; border: none; width: 100%; text-align: center; font-size: 17px; color: #007aff; cursor: pointer; }
    </style>
</head>
<body>
    <div class="list">
        <div class="header">
            <div class="nav">
                <a href="#" class="back" onclick="event.preventDefault()">‹ Carpetas</a>
                <button class="menu-btn" onclick="openMenu()"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></button>
            </div>
            <div class="title">Notas</div>
        </div>
        <div class="section">Últimos 7 días</div>
        <div id="notes"></div>
        <div class="footer" id="count">0 notas</div>
        <button class="create" onclick="createNote()">
            <div class="create-icon"></div>
        </button>
    </div>

    <div class="detail" id="detail">
        <div class="det-header">
            <a href="#" class="det-back" onclick="event.preventDefault(); closeDetail()">‹ Atrás</a>
            <div class="det-tools">
                <button class="tool" onclick="openNoteMenu()"><div class="more"><div class="more-dots"><div class="more-dot"></div><div class="more-dot"></div><div class="more-dot"></div></div></div></button>
            </div>
        </div>
        <div class="det-content">
            <div class="det-title" id="note-title">Predicción</div>
            <div class="det-text" id="text" style="display:none;">...</div>
            <textarea class="det-edit" id="edit" style="display:none;" placeholder="Escribe algo..."></textarea>
        </div>
    </div>

    <div class="menu" id="menu">
        <div class="menu-panel">
            <div class="menu-top"><div class="menu-title">Opciones</div><button class="close" onclick="closeMenu()">×</button></div>
            <button class="menu-option" onclick="check()">Estado de conexión</button>
        </div>
    </div>

    <div class="menu" id="note-menu">
        <div class="menu-panel">
            <div class="menu-top"><div class="menu-title">Nota</div><button class="close" onclick="closeNoteMenu()">×</button></div>
            <button class="menu-option" style="color: #ff3b30;" onclick="deleteCurrentNote()">Eliminar nota</button>
        </div>
    </div>

    <script>
        const K = 'calculadora-prediccion-data';
        const NOTES_KEY = 'notas-personales';
        let d = null;
        let personalNotes = [];
        let currentNoteId = null;
        let isEditing = false;

        function loadPersonalNotes() {
            try {
                personalNotes = JSON.parse(localStorage.getItem(NOTES_KEY) || '[]');
            } catch {
                personalNotes = [];
            }
        }

        function savePersonalNotes() {
            localStorage.setItem(NOTES_KEY, JSON.stringify(personalNotes));
        }

        function load() { 
            try { 
                d = JSON.parse(localStorage.getItem(K) || 'null'); 
            } catch { 
                d = null; 
            } 
            loadPersonalNotes();
            render(); 
        }

        function render() {
            const n = document.getElementById('notes');
            let html = '';
            
            // Notas personales primero (más recientes)
            const recentNotes = personalNotes.slice(-1); // Solo la más reciente primero
            recentNotes.forEach(note => {
                const date = new Date(note.timestamp);
                const time = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                const preview = note.content.substring(0, 50) + (note.content.length > 50 ? '...' : '');
                html += `<div class="note" onclick="openPersonalNote('${note.id}')"><div class="note-top"><div class="note-title">${note.title}</div><div class="note-date">${time}</div></div><div class="note-preview">${preview}</div></div>`;
            });
            
            // Predicción de la calculadora SIEMPRE SEGUNDA
            if (!d) {
                html += '<div class="note" onclick="openPrediction()"><div class="note-top"><div class="note-title">Predicción</div><div class="note-date">Esperando</div></div><div class="note-preview">Sin predicciones aún</div></div>';
            } else {
                const day = new Date(d.timestamp).toLocaleDateString('es-ES', { weekday: 'long' });
                html += `<div class="note" onclick="openPrediction()"><div class="note-top"><div class="note-title">Predicción</div><div class="note-date">${day}</div></div><div class="note-preview">Hoy haré un poco de magia para...</div></div>`;
            }

            // Resto de notas personales (si hay más)
            const olderNotes = personalNotes.slice(0, -1).reverse();
            olderNotes.forEach(note => {
                const date = new Date(note.timestamp);
                const time = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                const preview = note.content.substring(0, 50) + (note.content.length > 50 ? '...' : '');
                html += `<div class="note" onclick="openPersonalNote('${note.id}')"><div class="note-top"><div class="note-title">${note.title}</div><div class="note-date">${time}</div></div><div class="note-preview">${preview}</div></div>`;
            });

            n.innerHTML = html;
            document.getElementById('count').textContent = `${1 + personalNotes.length} ${personalNotes.length === 0 ? 'nota' : 'notas'}`;
        }

        function createNote() {
            const newNote = {
                id: Date.now().toString(),
                title: 'Nueva Nota',
                content: '',
                timestamp: new Date().toISOString()
            };
            personalNotes.push(newNote);
            savePersonalNotes();
            render();
            openPersonalNote(newNote.id);
            isEditing = true;
            showEditor();
        }

        function openPrediction() {
            currentNoteId = null;
            isEditing = false;
            document.getElementById('note-title').textContent = 'Predicción';
            let txt = !d ? 'Sin predicciones aún.\n\nUsa la calculadora mágica en modo Espectador+ y envía la información aquí.' :
                d.text || `Hoy haré un poco de magia para ${d.name || 'alguien muy especial'}. Tiene ${d.age} años y me da la sensación de que su signo zodiacal es ${d.zodiac}. Cada pequeño detalle suyo ha sido parte de la ilusión que he creado.`;
            document.getElementById('text').textContent = txt;
            document.getElementById('text').style.display = 'block';
            document.getElementById('edit').style.display = 'none';
            document.getElementById('detail').classList.add('active');
        }

        function openPersonalNote(id) {
            const note = personalNotes.find(n => n.id === id);
            if (!note) return;
            currentNoteId = id;
            isEditing = true;
            document.getElementById('note-title').textContent = note.title;
            document.getElementById('edit').value = note.content;
            showEditor();
            document.getElementById('detail').classList.add('active');
        }

        function showEditor() {
            document.getElementById('text').style.display = 'none';
            document.getElementById('edit').style.display = 'block';
        }

        function closeDetail() {
            if (isEditing && currentNoteId) {
                const note = personalNotes.find(n => n.id === currentNoteId);
                if (note) {
                    note.content = document.getElementById('edit').value;
                    savePersonalNotes();
                    render();
                }
            }
            document.getElementById('detail').classList.remove('active');
            currentNoteId = null;
            isEditing = false;
        }

        function openMenu() { document.getElementById('menu').classList.add('active'); }
        function closeMenu() { document.getElementById('menu').classList.remove('active'); }
        function check() { alert(localStorage.getItem(K) ? '✅ Conexión activa' : '⚠️ Sin datos'); closeMenu(); }
        
        function openNoteMenu() { 
            if (currentNoteId) {
                document.getElementById('note-menu').classList.add('active'); 
            }
        }
        function closeNoteMenu() { document.getElementById('note-menu').classList.remove('active'); }
        
        function deleteCurrentNote() {
            if (!currentNoteId) return;
            if (confirm('¿Eliminar esta nota?')) {
                personalNotes = personalNotes.filter(n => n.id !== currentNoteId);
                savePersonalNotes();
                closeNoteMenu();
                closeDetail();
                render();
            }
        }
        
        window.addEventListener('storage', e => { if (e.key === K) load(); });
        load();
        setInterval(load, 2000);
    </script>
</body>
</html>
